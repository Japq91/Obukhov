# Obukhov Length Calculation and Atmospheric Stability Classification

This repository contains scripts to calculate **Obukhov inverse length (Linv)** and classify atmospheric stability conditions (stable, unstable, neutral) using ERA5 data. Results are saved in NetCDF and CSV formats for further analysis.

---

## 📋 Contents
1. [Description](#-description)
2. [Directory Structure](#-directory-structure)
3. [Requirements](#-requirements)
4. [Usage](#-usage)
5. [Stability Classification](#-stability-classification)
6. [Key Parameters](#-key-parameters)
7. [Study Location](#-study-location)
8. [Limitations](#-limitations)
9. [References](#-references)

---
## Obukhov Length Calculation (ERA5-Specific)  
Based on [ERA5: How to calculate Obukhov Length](https://confluence.ecmwf.int/display/CKB/ERA5%3A+How+to+calculate+Obukhov+Length):  

### **Formula for Obukhov Length (L)**  
The Obukhov length is calculated as:  
```  
Linv = vk * g * tvst / (tv2 * ust**2)  #ECMWF ERA5 calc.
``` 
Where: 

- `vk` = 0.4 (Von Kármán).
- `g` = 9.81 m/s² (gravedad).
- `tvst` = -wtv / ust (escala de temperatura turbulenta).
- `tv2` = temperatura virtual a 2 m.
- `ust` = velocidad de fricción (u*).
```  
L = - (T₀ * u*³) / (k * g * H)  #IFS Doc. Cy49r1
```  
Where:  
- `T₀` = Surface temperature `[K]`  
- `u*` = Friction velocity `[m/s]`  (ustar)
- `k` = Von Kármán constant (0.4)  
- `g` = Gravitational acceleration (9.81) `[m/s²]`  
- `H` = Sensible heat flux `[W/m²]`

In this repository, we calculate the **inverse Obukhov length (`Linv = 1/L`)** to avoid division by near-zero values.  

## Description

### Core Scripts
1. **`obukhov_calculate.py`**  
   - Calculates Obukhov inverse length (`Linv`) and friction velocity (`u*`).  
   - **Input**: ERA5 NetCDF file with meteorological variables (`t2m`, `d2m`, `sp`, `ishf`, `ie`, `iews`, `inss`).  
   - **Output**: NetCDF file with `Linv` and `u*`.

2. **`save_events.py`**  
   - Classifies atmospheric conditions into **stable**, **unstable**, or **neutral** based on `Linv`.  
   - **Input**: NetCDF file generated by `obukhov_calculate.py`.  
   - **Output**: Three CSV files with hourly event counts per category.

---

## 🌳 Directory Structure
```
.
├── cods/                       # Scripts and automation files
│   ├── descarga_inst.py        # Data download script
│   ├── ejecuta.sh              # Execution script
│   ├── obukhov_calculate.py    # Main calculation script
│   └── save_events.py          # Stability classification script
├── datos/                      # Input data directory (ERA5 files)
├── out_csv/                    # Output CSV files
│   ├── neutral_199001.csv      # Neutral condition events
│   ├── stable_199001.csv       # Stable condition events
│   └── unstable_199001.csv     # Unstable condition events
├── out_nc/                     # Output NetCDF files
│   └── Lu_1990_01_.nc          # Sample NetCDF with Linv/u*
├── PDFs/                       # ECMWF documentation
│   ├── IFS_part1_Cy49r1.pdf    # IFS model documentation
│   └── ...                     # Other parts (2-8)
└── README.md                   # This file
```

---

## Requirements
- Python 3.8+
- Libraries:  
  ```bash
  pip install xarray numpy pandas netCDF4
  ```

---

## Usage

### 1. Calculate `Linv` and `u*`
```bash
python cods/obukhov_calculate.py datos/ERA5_data_2023_01.nc
```
- **Output**: `out_nc/Lu_2023_01_.nc`.

### 2. Classify Stability Events
```bash
python cods/save_events.py out_nc/Lu_2023_01_.nc
```
- **Outputs**:  
  - `out_csv/unstable_202301.csv`  
  - `out_csv/stable_202301.csv`  
  - `out_csv/neutral_202301.csv`

---

## Stability Classification
Based on [ECMWF IFS Documentation](https://www.ecmwf.int/sites/default/files/elibrary/112024/81626-ifs-documentation-cy49r1-part-iv-physical-processes.pdf):
- **Unstable**: `Linv < -0.01 m⁻¹`  
  _Positive heat flux (sunny days)_.
- **Stable**: `Linv > 0.01 m⁻¹`  
  _Negative heat flux (clear nights)_.
- **Neutral**: `-0.01 ≤ Linv ≤ 0.01 m⁻¹`  
  _Wind-dominated turbulence_.

---

## Key Parameters

### Input Variables
| Variable | Description | Unit |
|----------|-------------|------|
| `t2m`    | 2m temperature | K |
| `d2m`    | 2m dewpoint temperature | K |
| `sp`     | Surface pressure | Pa |
| `ishf`   | Sensible heat flux | W/m² |
| `ie`     | Evaporation flux | m/s |
| `iews`   | Eastward turbulent stress | N/m² |
| `inss`   | Northward turbulent stress | N/m² |

### Key Formulas
1. **Saturation specific humidity**:  
   ```python
   qs = (611.21 * exp(17.502*(t2m - 273.16)/(t2m - 32.19)) / sp
   ```
2. **Friction velocity (`u*`)**:  
   ```python
   ustar = sqrt(iews² + inss²) / sqrt(air_density)
   ```
3. **Obukhov inverse length (`Linv`)**:  
   ```python
   Linv = (0.4 * 9.81 * virtual_heat_flux) / (tv2 * ustar³)
   ```

---

## Study Location
```python
LAT_PONTO = -21.6389  # Latitude (e.g., Rio de Janeiro, Brazil)
LON_PONTO = -40.8693  # Longitude
```

---

## References
1. [ECMWF IFS Documentation CY49R1 - Part IV](https://www.ecmwf.int/sites/default/files/elibrary/112024/81626-ifs-documentation-cy49r1-part-iv-physical-processes.pdf)  
2. [ERA5: Obukhov Length Calculation Guide](https://confluence.ecmwf.int/display/CKB/ERA5%3A+How+to+calculate+Obukhov+Length)  
3. [ECMWF Parameter Database](https://apps.ecmwf.int/codes/grib/param-db)


> **Nota:** Para investigación avanzada, considere solicitar acceso a los parámetros de turbulencia directos mediante el Servicio de Soporte del ECMWF.

